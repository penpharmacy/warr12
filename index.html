<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>เครื่องคำนวณการให้ยา Warfarin โรงพยาบาลพุนพิน</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#E3F2FD;
  --card:#fff;
  --accent:#4CAF50;
  --muted:#607D8B;
  font-family: 'Kanit', sans-serif;
}
body{
  background:linear-gradient(180deg,var(--bg),#fff);
  margin:0;
  padding:20px;
  color:#263238;
}
body::before{
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('logo1.gif') center center no-repeat;
  background-size: 400px auto;
  opacity: 0.08;
  z-index: -1;
}
header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px;text-align:center;flex:1}
.container{max-width:980px;margin:20px auto}
.card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:18px;margin-bottom:16px}
label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;font-size:16px}
.row{display:flex;gap:12px}
.col{flex:1}
.radio-row{display:flex;gap:12px;flex-wrap:wrap}
.pill{padding:10px 14px;border-radius:18px;border:1px solid #eee;background:#fafafa}
button.primary{background:var(--accent);color:#fff;border:0;padding:12px 18px;border-radius:10px;font-weight:600}
.result{margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:center}
.small{font-size:13px;color:var(--muted)}
.note{background:#FFF8E1;padding:8px;border-radius:8px;margin-top:8px;white-space:pre-line;}
footer{font-size:13px;color:var(--muted);text-align:center;padding:8px}
@media(max-width:720px){.row{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
<header class="card" style="align-items:center">
<h1>เครื่องคำนวณการให้ยา Warfarin โรงพยาบาลพุนพิน</h1>
</header>

<section class="card">
<form id="form">
  <div class="row">
    <div class="col">
      <label>INR ปัจจุบัน</label>
      <input type="number" step="0.01" id="inr" min="0" value="2.5" required>
    </div>
    <div class="col">
      <label>ขนาดยา Warfarin ต่อสัปดาห์ (mg)</label>
      <input type="number" step="0.1" id="weeklyDose" min="0" value="35" required>
    </div>
    <div class="col">
      <label>จำนวนวันนัด (วัน)</label>
      <input type="number" id="days" min="1" value="7" required>
    </div>
  </div>

  <div style="margin-top:12px">
    <label>ชนิดเม็ดยาที่ใช้</label>
    <div class="radio-row">
      <label class="pill"><input type="radio" name="pills" value="3" checked> ใช้เม็ด 3 mg เท่านั้น</label>
      <label class="pill"><input type="radio" name="pills" value="2"> ใช้เม็ด 2 mg เท่านั้น</label>
      <label class="pill"><input type="radio" name="pills" value="both"> ใช้ทั้ง 2 และ 3 mg</label>
    </div>
  </div>

  <div style="margin-top:12px">
    <label>ภาวะเลือดออก</label>
    <div class="radio-row">
      <label class="pill"><input type="radio" name="bleed" value="no" checked> ไม่มี</label>
      <label class="pill"><input type="radio" name="bleed" value="yes"> มี</label>
    </div>
  </div>
</form>

<div id="results" class="result" style="display:none"></div>
</section>

<section id="tables" class="card" style="display:none">
<h3>ตารางแผนการให้ยา</h3>
<div id="plans"></div>
<div style="margin-top:12px;text-align:right">
  <button onclick="window.print()" class="primary">ดาวน์โหลด / พิมพ์ (PDF)</button>
</div>
</section>

<footer class="card small">คำเตือน: เครื่องมือนี้เป็นเครื่องมือช่วยคำนวณเท่านั้น ไม่ใช่คำสั่งการรักษา เเพทย์/เภสัชกรเป็นผู้ตัดสินใจขั้นสุดท้าย</footer>
</div>

<script>
function roundHalf(x){return Math.round(x*2)/2}
function distributeEvenly(total, days){
  const base = Math.floor(total/days);
  let arr = Array(days).fill(base);
  let rem = total - base*days;
  for(let i=0;i<rem;i++) arr[i]++;
  return arr;
}
function findBestCombo(target){
    const numSets = Math.round(target / 5); 
    const h3 = numSets; 
    const h2 = numSets; 
    const total = h3*3 + h2*2;
    return {h3:h3, h2:h2, total:total};
}

function buildPlan7Days(title, combo, weeklyDose){
    const days = 7;
    const perDay3 = distributeEvenly(combo.h3, days);
    const perDay2 = distributeEvenly(combo.h2, days);
    const totalWeekly = combo.h3*3 + combo.h2*2;
    const diffWeekPct = weeklyDose===0?0:((totalWeekly-weeklyDose)/weeklyDose)*100;
    let html = `<h4>${title} — รวม ${totalWeekly.toFixed(2)} mg/สัปดาห์ (${diffWeekPct>0?'+':''}${diffWeekPct.toFixed(2)}% จากเดิม)</h4>`;
    html += `<table><thead><tr><th>วัน</th><th>3 mg (เม็ด)</th><th>2 mg (เม็ด)</th><th>รวม (mg)</th></tr></thead><tbody>`;
    const dayNames = ['จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์','อาทิตย์'];
    for(let i=0;i<days;i++){
        const t3 = perDay3[i];
        const t2 = perDay2[i];
        const mg = t3*3 + t2*2;
        html += `<tr><td>${dayNames[i]}</td><td>${t3}</td><td>${t2}</td><td>${mg.toFixed(2)}</td></tr>`;
    }
    html += `</tbody></table>`;
    return html;
}

// ปรับสรุปจำนวนเม็ด: แสดงเฉพาะ >0 และไม่รวม mg
function buildSummaryRounded(combo, days){
    const perDay3 = distributeEvenly(combo.h3, 7);
    const perDay2 = distributeEvenly(combo.h2, 7);
    const total3 = Math.ceil(perDay3.reduce((a,b)=>a+b,0)/7*days);
    const total2 = Math.ceil(perDay2.reduce((a,b)=>a+b,0)/7*days);

    let summaryHTML = `<div class="note"><strong>สรุปจำนวนเม็ดยา (${days} วัน):</strong><br>`;
    let hasAny = false;
    if(total3 > 0){
        summaryHTML += `3 mg = ${total3} เม็ด<br>`;
        hasAny = true;
    }
    if(total2 > 0){
        summaryHTML += `2 mg = ${total2} เม็ด<br>`;
        hasAny = true;
    }
    if(!hasAny){
        summaryHTML += `ไม่มีการใช้ยา`;
    }
    summaryHTML += `</div>`;
    return summaryHTML;
}

function calculate(){
  const inr = parseFloat(document.getElementById('inr').value);
  const weeklyDose = parseFloat(document.getElementById('weeklyDose').value);
  const days = parseInt(document.getElementById('days').value,10);
  const pillChoice = document.querySelector('input[name="pills"]:checked').value;
  const bleed = document.querySelector('input[name="bleed"]:checked').value;
  if(isNaN(inr)||isNaN(weeklyDose)||isNaN(days)) return;

  const resDiv = document.getElementById('results');
  const tables = document.getElementById('tables');
  const plansDiv = document.getElementById('plans');

  if(bleed==='yes'){
    resDiv.innerHTML = `<div class="card"><p><strong>คำแนะนำ:</strong> พบภาวะเลือดออก: ให้ Vit K1 และพิจารณาการรักษาเฉียบพลันตามข้อแนะนำทางการแพทย์</p></div>`;
    resDiv.style.display='block';
    tables.style.display='none';
    plansDiv.innerHTML='';
    return;
  }

  let adj = {minPct:0,maxPct:0,avgPct:0,note:''};
  if(inr < 1.5){adj.minPct=0.10;adj.maxPct=0.20;adj.avgPct=0.15;adj.note='เพิ่มขนาดยารายสัปดาห์ 10–20%';}
  else if(inr>=1.5 && inr<=1.9){adj.minPct=0.05;adj.maxPct=0.10;adj.avgPct=0.075;adj.note='เพิ่ม 5–10% หรือพิจารณาไม่ปรับ แต่ติดตาม INR บ่อยขึ้น';}
  else if(inr>=2.0 && inr<=3.0){adj.minPct=0;adj.maxPct=0;adj.avgPct=0;adj.note='ไม่ต้องปรับยา';}
  else if(inr>=3.1 && inr<=3.9){adj.minPct=-0.10;adj.maxPct=-0.05;adj.avgPct=-0.075;adj.note='ลดขนาดยารายสัปดาห์ 5–10%';}
  else if(inr>3.9 && inr<5.0){adj.minPct=-0.10;adj.maxPct=-0.10;adj.avgPct=-0.10;adj.note='หยุดยา 1 วัน แล้วกลับมาเริ่มด้วยขนาดที่ลดลง 10%';}
  else if(inr>=5.0 && inr<9.0){adj.minPct=-0.20;adj.maxPct=-0.20;adj.avgPct=-0.20;adj.note='หยุดยา 2 วัน แล้วกลับมาเริ่มด้วยขนาดที่ลดลง 20% — พิจารณาให้ Vitamin K₁';}
  else if(inr>=9.0){adj.minPct=null;adj.maxPct=null;adj.avgPct=null;adj.note='INR > 9.0: หยุดยา ให้ Vitamin K₁ 2.5–5 mg รับประทาน และติดตาม INR อย่างใกล้ชิด';}

  let newRange = {};
  if(adj.minPct===null){ 
    newRange.note = 'ไม่แนะนำให้คำนวณขนาดยาอัตโนมัติสำหรับ INR >= 9.0 — ให้ผู้เชี่ยวชาญประเมิน'; 
  } else{
    const min = weeklyDose*(1+adj.minPct);
    const max = weeklyDose*(1+adj.maxPct);
    const avg = weeklyDose*(1+adj.avgPct);
    newRange = {
      minCalc: parseFloat(min.toFixed(2)),
      maxCalc: parseFloat(max.toFixed(2)),
      avgCalc: parseFloat(avg.toFixed(2)),
      min: roundHalf(min*2)/2,
      max: roundHalf(max*2)/2,
      avg: roundHalf(avg*2)/2
    };
  }

  let html = `<div class="card"><p><strong>คำแนะนำ:</strong> INR = ${inr.toFixed(2)} — ${adj.note}</p>`;
  if(newRange.note) html += `<p class="note">${newRange.note}</p>`; 
  else html += `<p>ขนาดยาใหม่ต่อสัปดาห์ (mg) : <strong>${newRange.minCalc.toFixed(2)} — ${newRange.maxCalc.toFixed(2)}</strong> (เฉลี่ย ${newRange.avgCalc.toFixed(2)} mg)</p>`;
  html += `</div>`;
  resDiv.innerHTML = html; 
  resDiv.style.display='block';

  plansDiv.innerHTML='';
  if(newRange.min!==undefined){
    const targets = [
       {k:'ต่ำสุด', val:newRange.min, pct:adj.minPct},
       {k:'เฉลี่ย', val:newRange.avg, pct:adj.avgPct},
       {k:'สูงสุด', val:newRange.max, pct:adj.maxPct}
    ];

    targets.forEach(t=>{
      let best;
      if(pillChoice==='3'){
        const h3=Math.round(t.val/3);
        best={h3:h3,h2:0,total:h3*3,type:'3mg'};
      } else if(pillChoice==='2'){
        const h2=Math.round(t.val/2);
        best={h3:0,h2:h2,total:h2*2,type:'2mg'};
      } else {
        best=findBestCombo(t.val);
        best.type='5mg';
      }

      plansDiv.innerHTML += buildPlan7Days(t.k,best,weeklyDose);
      plansDiv.innerHTML += buildSummaryRounded(best, days);
    });

    tables.style.display='block';
  } else {
    plansDiv.innerHTML=`<div class="note">${newRange.note}</div>`;
    tables.style.display='block';
  }
}

document.querySelectorAll('input[name="pills"]').forEach(el=>el.addEventListener('change',calculate));
document.querySelectorAll('input[name="bleed"]').forEach(el=>el.addEventListener('change',calculate));
document.getElementById('inr').addEventListener('input',calculate);
document.getElementById('weeklyDose').addEventListener('input',calculate);
document.getElementById('days').addEventListener('input',calculate);

calculate();
</script>
</body>
</html>
